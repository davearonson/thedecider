<% sorted_alts = @decision.alternatives.sort_by { |alt| -@percents[alt.id] } %>
<% sorted_facts = @decision.factors.sort_by { |fact| -fact.weight } %>


<% # we already got the decision name in the title %>
<% if @user.is_admin? && @decision.user_id != @user.id %>
  <h3>(from <%= @decision.user.username %>)</h3>
<% end %>

<table align="center" border="1">
  <tr valign="top">
    <td>
      <%= form_for @alternative do |f| %>
        <% if @alternative.errors.any? %>
          <div id="error_explanation">
            <h2><%= pluralize(@alternative.errors.count, "error") %>
            prohibited this alternative from being saved:
            </h2>
            <ul>
              <% @alternative.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <%= f.text_field :name %><br/>
        <%= hidden_field(:alternative, :decision_id, value: @decision.id) %>
        <%= f.submit "Add Alternative" %>
      <% end %>
    </td>

    <% sorted_alts.each do |alt| %>
      <td bgcolor="<%= Level.goodColors[@scores[alt.id]].name %>" >
        <%= form_for alt do |f| %>
          <% if alt.errors.any? %>
            <div id="error_explanation">
              <h2><%= pluralize(alt.errors.count, "error") %>
              prohibited this alternative from being saved:
              </h2>
              <ul>
                <% alt.errors.full_messages.each do |msg| %>
                  <li><%= msg %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <%= f.text_field :name, size: 10 %><br/>
          <%= hidden_field(:alternative, :decision_id, value: @decision.id) %>
          <%= f.submit "Update" %>
        <% end %>
        <%= link_to 'Remove', alt, method: :delete %>
      </td>
    <% end %>

  </tr>

  <% sorted_facts.each do |fac| %>
    <tr>
      <td>
        <%= form_for fac do |f| %>
          <% if fac.errors.any? %>
            <div id="error_explanation">
              <h2><%= pluralize(fac.errors.count, "error") %>
              prohibited this alternative from being saved:
              </h2>
              <ul>
                <% fac.errors.full_messages.each do |msg| %>
                  <li><%= msg %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <%= f.text_field :name %><br/>
          <%= collection_select(:factor, :weight_id,
                                Level.weightNames, :id, :name,
                                { selected: fac.weight } ) %>
          <%= hidden_field(:factor, :decision_id, value: @decision.id) %>
          <%= f.submit "Update" %>
        <% end %>
        <%= link_to 'Remove', fac, method: :delete %>
      </td>
      <% sorted_alts.each do |alt| %>
      <% rank = @rankings[[alt.id,fac.id]] %>
      <td bgcolor="<%= Level.goodColors[rank.weight - 1].name %>">
        <%= form_for rank do |f| %>
          <%= collection_select(:ranking, :weight_id,
                                Level.goodNames, :id, :name,
                                { selected: rank.weight },
                                { onChange: "submit()" } ) %>
        <% end %>
      </td>
    <% end %>
  <% end %>
  <tr>
    <td>
      
      <%= form_for @factor do |f| %>
        <% if @factor.errors.any? %>
          <div id="error_explanation">
            <h2><%= pluralize(@factor.errors.count, "error") %>
            prohibited this alternative from being saved:
            </h2>
            <ul>
              <% @factor.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <%= f.text_field :name %><br/>
        <%= collection_select(:factor, :weight_id,
                              Level.weightNames, :id, :name, 
                              selected: Level::Medium) %><%# TODO: WHY ISN'T PRESELECTION WORKING? %>
        <%= hidden_field(:factor, :decision_id, value: @decision.id) %>
        <%= f.submit "Add Factor" %>
      <% end %>
      
      
      
    </td>

    <% sorted_alts.each do |alt| %>
      <td bgcolor="<%= Level.goodColors[@scores[alt.id]].name %>">
        <b><big><%= Level.goodNames[@scores[alt.id]].name %></big></b><br/>
        (<%= number_to_percentage @percents[alt.id], precision: 0 %>)
      </td>
    <% end %>
  </tr>
</table>


<div style="text-align: center"><%= link_to 'Back to Decisions', decisions_path %></div>
